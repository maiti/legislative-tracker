<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegiScan Law Enforcement Training Legislation Tracker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            position: relative;
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            text-align: center;
        }
        .header p {
            margin: 0;
            text-align: center;
            opacity: 0.9;
            font-size: 16px;
        }
        .auth-controls {
            position: absolute;
            top: 15px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-info {
            font-size: 14px;
            color: rgba(255,255,255,0.9);
        }
        .admin-badge {
            background: rgba(46, 204, 113, 0.3);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            border: 1px solid rgba(46, 204, 113, 0.5);
            font-weight: 500;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .sync-status {
            background: rgba(52, 152, 219, 0.15);
            color: #2c3e50;
            padding: 12px 20px;
            font-size: 14px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }
        .controls-section {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        .search-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-select {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            min-width: 140px;
        }
        .search-btn, .sync-btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .search-btn:hover, .sync-btn:hover {
            background: #2980b9;
        }
        .sync-btn {
            background: #27ae60;
        }
        .sync-btn:hover {
            background: #229954;
        }
        .sync-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .stats-bar {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            color: #7f8c8d;
            margin-top: 4px;
        }
        .main-content {
            padding: 20px;
        }
        .loading {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
        }
        .loading-spinner {
            border: 4px solid #ecf0f1;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .bills-grid {
            display: grid;
            gap: 25px;
        }
        .bill-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 28px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .bill-card:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
            transform: translateY(-3px);
        }
        .bill-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .bill-number {
            background: #e3f2fd;
            color: #1976d2;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 12px;
        }
        .bill-state {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .bill-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin: 16px 0;
            line-height: 1.4;
        }
        .bill-summary {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 16px;
            margin: 16px 0;
            border-radius: 0 8px 8px 0;
        }
        .bill-summary h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 600;
        }
        .bill-summary p {
            margin: 0;
            color: #555;
            font-size: 13px;
            line-height: 1.5;
        }
        .bill-description {
            color: #555;
            line-height: 1.6;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .bill-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 16px;
        }
        .bill-status {
            background: #fff3cd;
            color: #856404;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }
        .bill-progress-container {
            margin-bottom: 16px;
        }
        .bill-progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #7f8c8d;
        }
        .progress-percentage {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        .bill-progress {
            width: 100%;
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }
        .bill-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            border-radius: 5px;
        }
        .bill-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }
        .keyword-tag {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .relevance-score {
            background: #ffeaa7;
            color: #e17055;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .relevance-high {
            background: #d5f4e6;
            color: #27ae60;
        }
        .relevance-medium {
            background: #ffeaa7;
            color: #e17055;
        }
        .relevance-low {
            background: #fadbd8;
            color: #e74c3c;
        }
        .no-bills {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
        }
        .no-bills-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            border-left: 4px solid #3498db;
            max-height: 200px;
            overflow-y: auto;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border-left: 4px solid #dc3545;
        }
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .login-form {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        .login-form h2 {
            margin: 0 0 24px 0;
            text-align: center;
            color: #2c3e50;
            font-size: 24px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-btn:hover {
            background: #2980b9;
        }
        .login-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .test-buttons {
            margin: 20px 0;
            text-align: center;
        }
        .test-btn {
            background: #e67e22;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        .test-btn:hover {
            background: #d35400;
        }
        .demo-creds {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            color: #6c757d;
            text-align: center;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
        }
        .error-alert {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            padding: 20px;
        }
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            background: white;
            color: #495057;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .page-btn:hover {
            background: #f8f9fa;
        }
        .page-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .sort-label {
            font-size: 13px;
            color: #6c757d;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-form">
            <h2>Legislative Tracker</h2>
            <div id="errorMessage" class="error-alert" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>
            
            <div class="test-buttons">
                <button id="testConnectionBtn" class="test-btn">Test Connection</button>
                <button id="testAPIBtn" class="test-btn">Test API</button>
            </div>
            
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="Enter your email" value="admin@example.com">
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" placeholder="Enter your password" value="admin123">
            </div>
            <button id="loginBtn" class="login-btn">Sign In</button>
            
            <div class="demo-creds">
                <strong>Demo Credentials:</strong><br>
                Email: admin@example.com<br>
                Password: admin123
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <div class="auth-controls">
                <div class="user-info">
                    <span id="userDisplay"></span>
                    <span id="adminBadge" class="admin-badge" style="display: none;">Admin</span>
                </div>
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>
            <h1>LegiScan Law Enforcement Training Legislation Tracker</h1>
            <p>Real-time tracking of legislation related to training for law enforcement and financial crime prevention</p>
        </div>
        
        <div id="syncStatus" class="sync-status">
            ðŸ”„ Loading system status...
        </div>

        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <div class="stat-number" id="totalBillsCount">-</div>
                <div class="stat-label">Total Bills</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="legiscanBillsCount">-</div>
                <div class="stat-label">LegiScan Bills</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="manualBillsCount">-</div>
                <div class="stat-label">Manual Bills</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="relevantBillsCount">-</div>
                <div class="stat-label">High Relevance</div>
            </div>
        </div>

        <div class="controls-section">
            <div class="search-controls">
                <input type="text" id="searchInput" class="search-input" placeholder="Search bills by title, description, or keywords...">
                <button id="searchBtn" class="search-btn">Search</button>
                <button id="syncBtn" class="sync-btn">Sync LegiScan</button>
            </div>
            
            <div class="filter-controls">
                <select id="stateFilter" class="filter-select">
                    <option value="all">All States</option>
                    <option value="US">Federal</option>
                    <option value="AL">Alabama</option>
                    <option value="CA">California</option>
                    <option value="FL">Florida</option>
                    <option value="NY">New York</option>
                    <option value="TX">Texas</option>
                </select>
                
                <select id="statusFilter" class="filter-select">
                    <option value="all">All Status</option>
                    <option value="introduced">Introduced</option>
                    <option value="committee">In Committee</option>
                    <option value="passed">Passed</option>
                    <option value="enacted">Enacted</option>
                </select>
                
                <span class="sort-label">Sort by:</span>
                <select id="sortSelect" class="filter-select">
                    <option value="relevanceScore">Relevance Score</option>
                    <option value="progressPercentage">Progress %</option>
                    <option value="introducedDate">Date Introduced</option>
                    <option value="title">Bill Title</option>
                    <option value="createdAt">Date Added</option>
                </select>
                
                <select id="sortOrderSelect" class="filter-select">
                    <option value="DESC">High to Low</option>
                    <option value="ASC">Low to High</option>
                </select>
            </div>
        </div>

        <div id="debugInfo" class="debug-info">
            <strong>Debug Information:</strong><br>
            <span id="debugText">Initializing...</span>
        </div>
        
        <div class="main-content">
            <div id="loadingIndicator" class="loading">
                <div class="loading-spinner"></div>
                Loading legislative data...
            </div>
            
            <div id="billsContainer" style="display: none;">
                <div class="bills-grid" id="billsGrid"></div>
                <div class="pagination" id="pagination"></div>
            </div>
            
            <div id="noBillsMessage" class="no-bills" style="display: none;">
                <div class="no-bills-icon">ðŸ“‹</div>
                <h3>No Bills Found</h3>
                <p>Try adjusting your search criteria or sync with LegiScan to get the latest data.</p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let authToken = null;
        let debugLog = [];
        let allBills = [];
        let filteredBills = [];
        let currentPage = 1;
        let billsPerPage = 10;

        // Keywords we're tracking
        const TRACKING_KEYWORDS = [
            'Financial crimes', 'Fraud investigation', 'Anti-money laundering', 'AML',
            'Economic crimes', 'White-collar crime', 'Asset forfeiture', 'Illicit finance',
            'Investigative accounting', 'Forensic auditing', 'Financial intelligence',
            'Money laundering prevention', 'Financial analysis training', 'Law enforcement training',
            'Technical assistance', 'Capacity building', 'Justice assistance grants',
            'Training and technical assistance', 'TTA', 'Evidence-based practices',
            'Criminal justice system improvement', 'Intelligence sharing',
            'Multi-jurisdictional task forces', 'Cybercrime', 'Digital forensics'
        ];

        function addDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `${timestamp}: ${message}`;
            debugLog.push(logMessage);
            
            if (debugLog.length > 15) {
                debugLog = debugLog.slice(-15);
            }
            
            const debugElement = document.getElementById('debugText');
            if (debugElement) {
                debugElement.innerHTML = debugLog.join('<br>');
            }
            console.log('DEBUG:', logMessage);
        }

        function clearAuthData() {
            try {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('user');
            } catch (e) {
                addDebug('LocalStorage not available');
            }
            currentUser = null;
            authToken = null;
            addDebug('Auth data cleared');
        }

        function showLogin() {
            const loginOverlay = document.getElementById('loginOverlay');
            const mainContainer = document.getElementById('mainContainer');
            if (loginOverlay) loginOverlay.style.display = 'flex';
            if (mainContainer) mainContainer.style.display = 'none';
            addDebug('Login screen shown');
        }

        function showMainInterface() {
            addDebug('Showing main interface');
            const loginOverlay = document.getElementById('loginOverlay');
            const mainContainer = document.getElementById('mainContainer');
            const userDisplay = document.getElementById('userDisplay');
            const adminBadge = document.getElementById('adminBadge');
            
            if (loginOverlay) loginOverlay.style.display = 'none';
            if (mainContainer) mainContainer.style.display = 'block';
            if (userDisplay && currentUser) {
                userDisplay.textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            }
            
            if (adminBadge && currentUser && currentUser.role === 'admin') {
                adminBadge.style.display = 'inline';
                addDebug('Admin privileges enabled');
            }
        }

        function showMessage(message, isError = true) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            if (isError) {
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                }
                if (successDiv) {
                    successDiv.style.display = 'none';
                }
            } else {
                if (successDiv) {
                    successDiv.textContent = message;
                    successDiv.style.display = 'block';
                }
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
                
                setTimeout(() => {
                    if (successDiv) successDiv.style.display = 'none';
                }, 5000);
            }
            
            addDebug(`Message shown (${isError ? 'error' : 'success'}): ${message}`);
        }

        async function testConnection() {
            addDebug('Testing basic connection...');
            try {
                const response = await fetch('/health');
                addDebug(`Health response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                addDebug(`Health check data: ${JSON.stringify(data)}`);
                showMessage(`Connection OK: ${data.status}`, false);
            } catch (error) {
                addDebug(`Connection failed: ${error.message}`);
                showMessage(`Connection Error: ${error.message}`, true);
            }
        }

        async function testAPICall() {
            addDebug('Testing API endpoint...');
            try {
                const response = await fetch('/api');
                addDebug(`API response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                addDebug(`API test data: ${JSON.stringify(data).substring(0, 100)}...`);
                showMessage(`API OK: ${data.message}`, false);
            } catch (error) {
                addDebug(`API test failed: ${error.message}`);
                showMessage(`API Error: ${error.message}`, true);
            }
        }

        async function performLogin() {
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            
            if (!emailInput || !passwordInput || !loginBtn) {
                addDebug('Login form elements not found');
                return;
            }
            
            const email = emailInput.value;
            const password = passwordInput.value;
            
            addDebug(`STARTING LOGIN for: ${email}`);

            if (!email || !password) {
                addDebug('Missing credentials');
                showMessage('Please enter both email and password', true);
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing In...';

            try {
                addDebug('Creating login request...');
                
                const loginData = { email, password };
                const requestOptions = {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                };
                
                addDebug('Sending request to /api/auth/login...');
                const response = await fetch('/api/auth/login', requestOptions);
                
                addDebug(`Response status: ${response.status}`);
                
                const responseText = await response.text();
                addDebug(`Raw response length: ${responseText.length} chars`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                    addDebug('Response parsed successfully as JSON');
                } catch (parseError) {
                    addDebug(`JSON parse error: ${parseError.message}`);
                    throw new Error('Server returned invalid JSON');
                }

                if (data.accessToken) {
                    try {
                        localStorage.setItem('accessToken', data.accessToken);
                        localStorage.setItem('user', JSON.stringify(data.user));
                    } catch (e) {
                        addDebug('Cannot save to localStorage, continuing anyway');
                    }
                    
                    currentUser = data.user;
                    authToken = data.accessToken;
                    addDebug('Login successful, showing main interface');
                    showMainInterface();
                    loadDashboard();
                } else {
                    addDebug('No token in response');
                    showMessage(data.error || 'Login failed - no token received', true);
                }

            } catch (error) {
                addDebug(`LOGIN ERROR: ${error.message}`);
                showMessage(`Login failed: ${error.message}`, true);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        function logout() {
            addDebug('Logging out');
            clearAuthData();
            showLogin();
        }

        async function loadDashboard() {
            addDebug('Loading dashboard...');
            await Promise.all([
                loadBills(),
                loadSyncStatus()
            ]);
        }

        async function loadBills() {
            addDebug('Loading bills...');
            
            if (!authToken) {
                addDebug('No auth token - cannot load bills');
                showMessage('Authentication required', true);
                return;
            }

            const loadingIndicator = document.getElementById('loadingIndicator');
            const billsContainer = document.getElementById('billsContainer');
            const noBillsMessage = document.getElementById('noBillsMessage');
            
            if (loadingIndicator) loadingIndicator.style.display = 'block';
            if (billsContainer) billsContainer.style.display = 'none';
            if (noBillsMessage) noBillsMessage.style.display = 'none';

            try {
                const sortBy = document.getElementById('sortSelect')?.value || 'relevanceScore';
                const sortOrder = document.getElementById('sortOrderSelect')?.value || 'DESC';
                
                const searchParams = new URLSearchParams({
                    limit: '50',
                    sortBy: sortBy,
                    sortOrder: sortOrder
                });

                const response = await fetch(`/api/bills?${searchParams}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                addDebug(`Bills response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                addDebug(`Bills data received: ${data.bills ? data.bills.length : 0} bills`);
                
                allBills = data.bills || [];
                updateStats(data.stats || {});
                filterAndDisplayBills();

            } catch (error) {
                addDebug(`Error loading bills: ${error.message}`);
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = `
                        <div style="color: #e74c3c; text-align: center;">
                            <h3>Error Loading Bills</h3>
                            <p>${error.message}</p>
                            <button id="retryBillsBtn" style="padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 15px;">Try Again</button>
                        </div>
                    `;
                    
                    const retryBtn = document.getElementById('retryBillsBtn');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', loadBills);
                    }
                }
            }
        }

        function updateStats(stats) {
            const totalBillsCount = document.getElementById('totalBillsCount');
            const legiscanBillsCount = document.getElementById('legiscanBillsCount');
            const manualBillsCount = document.getElementById('manualBillsCount');
            const relevantBillsCount = document.getElementById('relevantBillsCount');
            
            if (totalBillsCount) totalBillsCount.textContent = stats.totalBills || allBills.length || 0;
            if (legiscanBillsCount) legiscanBillsCount.textContent = stats.legiscanBills || 0;
            if (manualBillsCount) manualBillsCount.textContent = stats.manualBills || 0;
            if (relevantBillsCount) {
                const highRelevance = allBills.filter(bill => (bill.relevanceScore || 0) >= 5).length;
                relevantBillsCount.textContent = highRelevance;
            }
        }

        function filterAndDisplayBills() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const stateFilter = document.getElementById('stateFilter')?.value || 'all';
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            
            filteredBills = allBills.filter(bill => {
                const matchesSearch = !searchTerm || 
                    (bill.title && bill.title.toLowerCase().includes(searchTerm)) ||
                    (bill.description && bill.description.toLowerCase().includes(searchTerm)) ||
                    (bill.keywords && bill.keywords.toLowerCase().includes(searchTerm)) ||
                    (bill.billNumber && bill.billNumber.toLowerCase().includes(searchTerm));
                
                const matchesState = stateFilter === 'all' || bill.stateCode === stateFilter;
                
                const matchesStatus = statusFilter === 'all' || 
                    (bill.status && bill.status.toLowerCase().includes(statusFilter));
                
                return matchesSearch && matchesState && matchesStatus;
            });
            
            // Apply sorting
            const sortBy = document.getElementById('sortSelect')?.value || 'relevanceScore';
            const sortOrder = document.getElementById('sortOrderSelect')?.value || 'DESC';
            
            filteredBills.sort((a, b) => {
                let aVal = a[sortBy] || 0;
                let bVal = b[sortBy] || 0;
                
                // Handle string sorting
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                }
                
                if (sortOrder === 'DESC') {
                    return bVal > aVal ? 1 : bVal < aVal ? -1 : 0;
                } else {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                }
            });
            
            currentPage = 1;
            displayBills();
        }

        function generateBillSummary(bill) {
            const keywords = bill.keywords ? bill.keywords.split(',').map(k => k.trim()).filter(k => k) : [];
            const relevanceScore = bill.relevanceScore || 0;
            
            let relevanceText = '';
            let summaryText = '';
            
            // Determine relevance level
            if (relevanceScore >= 7) {
                relevanceText = 'Very High Relevance';
            } else if (relevanceScore >= 5) {
                relevanceText = 'High Relevance';
            } else if (relevanceScore >= 3) {
                relevanceText = 'Medium Relevance';
            } else {
                relevanceText = 'Low Relevance';
            }
            
            // Generate summary based on bill content
            if (keywords.length > 0) {
                const keywordText = keywords.slice(0, 3).join(', ');
                summaryText = `This bill addresses ${keywordText.toLowerCase()} and is ${relevanceText.toLowerCase()} to law enforcement training and financial crime prevention initiatives.`;
                
                if (bill.fundsAllocated && bill.fundsAllocated !== 'Not specified') {
                    summaryText += ` Funding: ${bill.fundsAllocated}.`;
                }
                
                if (bill.progressPercentage > 50) {
                    summaryText += ' This bill has made significant legislative progress.';
                } else if (bill.progressPercentage > 0) {
                    summaryText += ' This bill is in early legislative stages.';
                }
            } else {
                summaryText = `This bill is ${relevanceText.toLowerCase()} to our tracking criteria and may contain provisions related to law enforcement training or financial crime prevention.`;
            }
            
            return {
                relevance: relevanceText,
                summary: summaryText
            };
        }

        function displayBills() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const billsContainer = document.getElementById('billsContainer');
            const noBillsMessage = document.getElementById('noBillsMessage');
            const billsGrid = document.getElementById('billsGrid');
            
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            
            if (filteredBills.length === 0) {
                if (billsContainer) billsContainer.style.display = 'none';
                if (noBillsMessage) noBillsMessage.style.display = 'block';
                return;
            }
            
            if (billsContainer) billsContainer.style.display = 'block';
            if (noBillsMessage) noBillsMessage.style.display = 'none';
            
            const startIndex = (currentPage - 1) * billsPerPage;
            const endIndex = startIndex + billsPerPage;
            const billsToShow = filteredBills.slice(startIndex, endIndex);
            
            if (billsGrid) {
                billsGrid.innerHTML = '';
                
                billsToShow.forEach(bill => {
                    const billCard = document.createElement('div');
                    billCard.className = 'bill-card';
                    
                    const keywords = bill.keywords ? bill.keywords.split(',').map(k => k.trim()).filter(k => k) : [];
                    const keywordTags = keywords.slice(0, 4).map(keyword => 
                        `<span class="keyword-tag">${keyword}</span>`
                    ).join('');
                    
                    const relevanceScore = bill.relevanceScore || 0;
                    let relevanceClass = 'relevance-low';
                    if (relevanceScore >= 7) relevanceClass = 'relevance-high';
                    else if (relevanceScore >= 4) relevanceClass = 'relevance-medium';
                    
                    const relevanceTag = `<span class="relevance-score ${relevanceClass}">Relevance: ${relevanceScore}</span>`;
                    
                    const progressPercentage = bill.progressPercentage || 0;
                    
                    // Generate bill summary
                    const summary = generateBillSummary(bill);
                    
                    billCard.innerHTML = `
                        <div class="bill-header">
                            <div>
                                <span class="bill-number">${bill.billNumber || 'Unknown'}</span>
                                <span class="bill-state">${bill.stateCode || 'Unknown'}</span>
                            </div>
                        </div>
                        <h3 class="bill-title">${bill.title || 'No title available'}</h3>
                        
                        <div class="bill-summary">
                            <h4>Summary & Relevance</h4>
                            <p>${summary.summary}</p>
                        </div>
                        
                        <div class="bill-meta">
                            <span class="bill-status">${bill.status || 'Unknown'}</span>
                            <span>Source: ${bill.sourceType || 'Unknown'}</span>
                        </div>
                        
                        <div class="bill-progress-container">
                            <div class="bill-progress-label">
                                <span>Legislative Progress</span>
                                <span class="progress-percentage">${progressPercentage}%</span>
                            </div>
                            <div class="bill-progress">
                                <div class="bill-progress-fill" style="width: ${progressPercentage}%"></div>
                            </div>
                        </div>
                        
                        <p class="bill-description">${(bill.description || 'No description available').substring(0, 200)}${bill.description && bill.description.length > 200 ? '...' : ''}</p>
                        
                        <div class="bill-keywords">
                            ${keywordTags}
                            ${relevanceTag}
                        </div>
                    `;
                    
                    billsGrid.appendChild(billCard);
                });
            }
            
            updatePagination();
            addDebug(`Displayed ${billsToShow.length} bills (page ${currentPage})`);
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            if (!pagination) return;
            
            const totalPages = Math.ceil(filteredBills.length / billsPerPage);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            pagination.innerHTML = '';
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.textContent = 'â† Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayBills();
                }
            });
            pagination.appendChild(prevBtn);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => {
                        currentPage = i;
                        displayBills();
                    });
                    pagination.appendChild(pageBtn);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px';
                    pagination.appendChild(ellipsis);
                }
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.textContent = 'Next â†’';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayBills();
                }
            });
            pagination.appendChild(nextBtn);
        }

        async function loadSyncStatus() {
            addDebug('Loading sync status...');
            const syncStatus = document.getElementById('syncStatus');
            
            if (!currentUser || currentUser.role !== 'admin') {
                if (syncStatus) {
                    syncStatus.innerHTML = 'ðŸ“Š Bills loaded from database â€¢ Ready to search and filter';
                }
                return;
            }
            
            try {
                const response = await fetch('/api/admin/sync-status', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                addDebug(`Sync status loaded: ${data.totalBills} total bills`);
                
                if (syncStatus) {
                    const lastSync = data.lastSync ? new Date(data.lastSync).toLocaleString() : 'Never';
                    const isRunning = data.currentlyRunning ? ' â€¢ ðŸ”„ Sync in progress' : '';
                    
                    syncStatus.innerHTML = `ðŸ“Š Total: ${data.totalBills} â€¢ ðŸ¤– LegiScan: ${data.legiscanBills} â€¢ âœ‹ Manual: ${data.manualBills} â€¢ ðŸ•’ Last Sync: ${lastSync}${isRunning}`;
                }
            } catch (error) {
                addDebug(`Error loading sync status: ${error.message}`);
                if (syncStatus) {
                    syncStatus.innerHTML = 'âš ï¸ Sync status unavailable â€¢ System operational';
                }
            }
        }

        async function syncLegiScan() {
            if (!currentUser || currentUser.role !== 'admin') {
                showMessage('Admin access required for manual sync', true);
                return;
            }
            
            const syncBtn = document.getElementById('syncBtn');
            if (!syncBtn) return;
            
            addDebug('Starting manual LegiScan sync...');
            
            syncBtn.disabled = true;
            syncBtn.textContent = 'Syncing...';
            
            try {
                const response = await fetch('/api/admin/sync-bills', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                addDebug(`Sync initiated: ${data.message}`);
                showMessage('LegiScan sync started in background. New bills will appear within a few minutes.', false);
                
                // Refresh the page after a short delay
                setTimeout(() => {
                    loadDashboard();
                }, 10000);
                
            } catch (error) {
                addDebug(`Sync error: ${error.message}`);
                showMessage(`Sync failed: ${error.message}`, true);
            } finally {
                setTimeout(() => {
                    syncBtn.disabled = false;
                    syncBtn.textContent = 'Sync LegiScan';
                }, 5000);
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            addDebug('DOM loaded, setting up enhanced app...');
            
            clearAuthData();
            showLogin();
            
            // Set up event listeners
            const testConnectionBtn = document.getElementById('testConnectionBtn');
            const testAPIBtn = document.getElementById('testAPIBtn');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const passwordInput = document.getElementById('password');
            const searchBtn = document.getElementById('searchBtn');
            const syncBtn = document.getElementById('syncBtn');
            const searchInput = document.getElementById('searchInput');
            const stateFilter = document.getElementById('stateFilter');
            const statusFilter = document.getElementById('statusFilter');
            const sortSelect = document.getElementById('sortSelect');
            const sortOrderSelect = document.getElementById('sortOrderSelect');
            
            if (testConnectionBtn) {
                testConnectionBtn.addEventListener('click', testConnection);
                addDebug('Test Connection button listener added');
            }
            
            if (testAPIBtn) {
                testAPIBtn.addEventListener('click', testAPICall);
                addDebug('Test API button listener added');
            }
            
            if (loginBtn) {
                loginBtn.addEventListener('click', performLogin);
                addDebug('Login button listener added');
            }
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
                addDebug('Logout button listener added');
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performLogin();
                    }
                });
                addDebug('Password enter key listener added');
            }
            
            if (searchBtn) {
                searchBtn.addEventListener('click', filterAndDisplayBills);
                addDebug('Search button listener added');
            }
            
            if (syncBtn) {
                syncBtn.addEventListener('click', syncLegiScan);
                addDebug('Sync button listener added');
            }
            
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        filterAndDisplayBills();
                    }
                });
                searchInput.addEventListener('input', function() {
                    // Debounced search
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(filterAndDisplayBills, 500);
                });
                addDebug('Search input listeners added');
            }
            
            if (stateFilter) {
                stateFilter.addEventListener('change', filterAndDisplayBills);
                addDebug('State filter listener added');
            }
            
            if (statusFilter) {
                statusFilter.addEventListener('change', filterAndDisplayBills);
                addDebug('Status filter listener added');
            }
            
            if (sortSelect) {
                sortSelect.addEventListener('change', loadBills);
                addDebug('Sort select listener added');
            }
            
            if (sortOrderSelect) {
                sortOrderSelect.addEventListener('change', loadBills);
                addDebug('Sort order select listener added');
            }
            
            addDebug('All enhanced event listeners set up');
            
            // Test connection automatically
            setTimeout(() => {
                addDebug('Running automatic connection test...');
                testConnection();
            }, 1000);
        });
    </script>
</body>
</html>